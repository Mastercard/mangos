[Distribution]
# I'm most comfortable debugging Ubuntu.
# If we do this right, it shouldn't matter.
Distribution=ubuntu
Repositories=main,universe
Release=oracular

[Content]
# Generated using `openssl passwd -6`
RootPassword=hashed:$6$OM2raXimIv8ucv8M$KwmcGa3kMjKlxvvpVdTVZ9khXy5pp2FJU0gNWqJ6nEMG7Yut2sxILhr7bs/yEC.WoUYP.hlBWt0zn4W7XCcyi.

# System TZ should always be UTC. Users can set their own, if they want.
Timezone=UTC

Bootable=yes

# Assuming it's easier if this is consistent. For environments without
# BIOS requirements, it would be great if systemd-boot could be a drop-in
# replacement.
Bootloader=grub
BiosBootloader=grub


# This might come in handy: https://www.debian.org/doc/manuals/aptitude/ch02s04s05.en.html
Packages=
    # systemd-repart dlopen()s libtss2-esys.so.0, libtss2-rc.so.0, and libtss2-mu.so.0
    ^libtss2-esys-[0-9.]+-0$
    ^libtss2-mu[0-9.-]+$
    libtss2-rc0
    libtss2-tcti-device0

    # Needed by mangos-config-ec2
    wget

    # Needed by simple yq (syq)
    python3-yaml

    # modprobe and friends
    kmod

    # We need our device nodes
    udev

    # Adds udev rules for device mapped devices
    dmsetup

    # Makes systemd /sbin/init
    systemd-sysv

    # The systemd boot binaries
    systemd-boot

    # Required for talking to systemd
    dbus

    # CA certificates
    ca-certificates

    # systemd's DNS resolver
    systemd-resolved

    iproute2

    # Enable SSH access
    openssh-server

    # Needed for systemd-pull which is used by sysupdate
    systemd-container

    gpg

    # Enable login on console
    login

    # BIOS bootloader
    grub-pc-bin
    grub2-common

    # For the grub EFI binary
    grub-efi-amd64-bin
    grub-efi-amd64-signed

    gdisk
    pciutils
    lshw

ExtraTrees=sshd-keygen:/usr/lib/sshd-keygen
           sshd-keygen@.service:/usr/lib/systemd/system/
           sshd-keygen.target:/usr/lib/systemd/system/

[Build]
CacheDirectory=%D/.cache
# Make mkosi remember previous build. This improves cache use.
History=yes
# Reuses partial builds, so also improves cache use.
Incremental=yes

[Config]
#Dependencies=initrd,admin-toolbox
Profiles=verity-full

[Include]
Include=%D/resources/common-kernel

[Output]
OutputMode=644
ImageId=mangos
Format=disk
OutputDirectory=out
SplitArtifacts=uki,kernel,initrd,partitions,roothash,tar
CompressOutput=none
ManifestFormat=json #,changelog

[Content]
# Overrides the default initrd generation
Initrds=%O/initrd

Ssh=no
#BaseTrees=%O/release_%v
Bootable=yes
Bootloader=grub
BiosBootloader=grub
KernelModulesInitrd=yes
KernelModulesInclude=netfilter
                     /veth.ko

[Validation]
Checksum=yes
SecureBoot=yes
SignExpectedPcr=yes
SecureBootKey=%D/mkosi.key
SecureBootCertificate=%D/mkosi.crt

[Runtime]
Ephemeral=yes
KVM=yes
RuntimeNetwork=user
RuntimeSize=20G
Firmware=uefi
TPM=False
Ephemeral=yes
RAM=4G
CPUs=2
VSock=yes
